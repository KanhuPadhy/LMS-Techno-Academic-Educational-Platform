name: LMS Smoke Test (CI + manual + email notify)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      api_url:
        description: "API base URL to test (optional). If blank, the default is https://api.kctronics.in"
        required: false
        default: "https://api.kctronics.in"

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (jq, curl)
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Make script executable
        run: chmod +x ./lms_smoketest.sh

      - name: Run smoke test
        env:
          API_URL: ${{ github.event.inputs.api_url || 'https://api.kctronics.in' }}
        run: |
          echo "Running smoke test against ${API_URL}"
          ./lms_smoketest.sh "${API_URL}"

  notify:
    needs: smoke-test
    if: ${{ needs.smoke-test.result == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (to include run link in email)
        uses: actions/checkout@v4

      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          from: ${{ secrets.NOTIFY_FROM }}
          to: ${{ secrets.NOTIFY_TO }}
          subject: "LMS Smoke Test FAILED â€” repo: ${{ github.repository }}"
          body: |
            The LMS smoke-test workflow failed.

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please check the Actions logs for details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: 'false'  # set 'true' if using SMTPS on port 465
